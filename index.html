<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekman Transport Visualizer</title>
    
    <!-- 다크/라이트 모드 자동 전환 CSS -->
    <style>
        /* CSS 변수로 테마 정의 */
        :root {
            --bg-primary: #f0f0f0;
            --bg-secondary: white;
            --border-color: #d0d0d0;
            --text-primary: #000;
            --text-secondary: #333;
            --button-bg: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
            --button-hover: linear-gradient(to bottom, #f5f5f5 0%, #e5e5e5 100%);
            --button-active: linear-gradient(to bottom, #e0e0e0 0%, #f0f0f0 100%);
            --input-bg: white;
            --slider-bg: #e0e0e0;
            --plot-bg: white;
            --chart-bg: white;
            --chart-grid: lightgray;
        }
        
        /* 다크 모드 테마 */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #2b2b2b;
                --bg-secondary: #1e1e1e;
                --border-color: #404040;
                --text-primary: #ffffff;
                --text-secondary: #e0e0e0;
                --button-bg: linear-gradient(to bottom, #404040 0%, #303030 100%);
                --button-hover: linear-gradient(to bottom, #4a4a4a 0%, #3a3a3a 100%);
                --button-active: linear-gradient(to bottom, #303030 0%, #404040 100%);
                --input-bg: #2d2d2d;
                --slider-bg: #404040;
                --plot-bg: #1e1e1e;
                --chart-bg: #2b2b2b;
                --chart-grid: #404040;
            }
        }
        
        /* 기본 스타일 (테마 변수 사용) */
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            font-size: 9pt;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .main-window {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            display: flex;
            min-height: calc(100vh - 16px);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* 왼쪽 제어 패널 */
        .control-frame {
            width: 320px;
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto;
            overflow-x: hidden;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .labelframe {
            border: 2px groove var(--border-color);
            margin: 8px 0;
            padding: 8px;
            background-color: var(--bg-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .labelframe-title {
            font-weight: bold;
            font-size: 9pt;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            padding: 0 4px;
            margin-left: 8px;
            position: relative;
            top: -16px;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        
        /* 버튼 스타일 */
        .tk-button {
            background: var(--button-bg);
            border: 1px outset var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            margin: 2px;
            font-size: 8pt;
            cursor: pointer;
            min-width: 60px;
            font-family: 'Segoe UI', Arial, sans-serif;
            transition: all 0.3s ease;
        }
        
        .tk-button:hover {
            background: var(--button-hover);
            border-color: var(--border-color);
        }
        
        .tk-button:active {
            border: 1px inset var(--border-color);
            background: var(--button-active);
        }
        
        /* 라벨 스타일 */
        .tk-label {
            font-size: 8pt;
            color: var(--text-primary);
            margin: 2px 0;
            background-color: var(--bg-primary);
            display: block;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        
        /* 슬라이더 스타일 */
        .tk-scale {
            width: 200px;
            height: 20px;
            margin: 4px 0;
            background: var(--slider-bg);
            border: 1px inset var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .tk-scale::-webkit-slider-thumb {
            width: 16px;
            height: 16px;
            background: var(--button-bg);
            border: 1px outset var(--border-color);
            cursor: pointer;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        /* 콤보박스 스타일 */
        .tk-combobox {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px inset var(--border-color);
            padding: 2px;
            font-size: 8pt;
            width: 150px;
            transition: all 0.3s ease;
        }
        
        /* 라디오 버튼 */
        .tk-radiobutton {
            font-size: 8pt;
            margin: 2px 0;
            background-color: var(--bg-primary);
            transition: background-color 0.3s ease;
        }
        
        /* 오른쪽 플롯 영역 */
        .plot-frame {
            flex: 1;
            background-color: var(--plot-bg);
            border: 2px groove var(--border-color);
            margin: 5px;
            padding: 5px;
            min-height: calc(100vh - 100px);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* 결과 표시 영역 */
        .results-grid {
            display: grid;
            grid-template-columns: auto auto;
            gap: 4px;
            font-size: 8pt;
        }
        
        .result-label {
            text-align: right;
            padding-right: 8px;
            font-weight: normal;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .result-value {
            text-align: left;
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        /* 버튼 그룹 */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin: 4px 0;
        }
        
        /* 슬라이더 컨테이너 */
        .slider-container {
            margin: 8px 0;
        }
        
        .slider-value {
            font-family: 'Courier New', monospace;
            font-size: 8pt;
            margin-left: 8px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        /* 제목 바 */
        .title-bar {
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px;
            font-weight: bold;
            font-size: 10pt;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        /* 다크 모드에서 스크롤바 스타일 */
        @media (prefers-color-scheme: dark) {
            ::-webkit-scrollbar {
                width: 12px;
            }
            
            ::-webkit-scrollbar-track {
                background: var(--bg-primary);
            }
            
            ::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 6px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        }
        
        /* 다크 모드에서 입력 필드 스타일 개선 */
        @media (prefers-color-scheme: dark) {
            input[type="range"] {
                accent-color: #4a9eff;
            }
            
            option {
                background-color: var(--input-bg);
                color: var(--text-primary);
            }
        }
        
        /* 플롯 영역 최적화 */
        #plot-area {
            width: 100% !important;
            height: 100% !important;
            min-height: calc(100vh - 120px);
        }
        
        /* Plotly 차트 컨테이너 최적화 */
        .plot-container {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* 향상된 모바일 햄버거 메뉴 */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: 15px;
            left: 15px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            background: var(--button-bg);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            padding: 0;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            touch-action: manipulation;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .mobile-menu-toggle:hover {
            background: var(--button-hover);
            transform: scale(1.05);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }
        
        .mobile-menu-toggle:active {
            transform: scale(0.95);
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        
        /* 햄버거 아이콘 애니메이션 */
        .hamburger {
            width: 24px;
            height: 18px;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        
        .hamburger span {
            display: block;
            height: 3px;
            background: var(--text-primary);
            border-radius: 2px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform-origin: center;
        }
        
        .hamburger span:nth-child(1) {
            width: 100%;
        }
        
        .hamburger span:nth-child(2) {
            width: 80%;
            align-self: center;
        }
        
        .hamburger span:nth-child(3) {
            width: 100%;
        }
        
        /* 활성 상태 - X 아이콘으로 변환 */
        .mobile-menu-toggle.active .hamburger span:nth-child(1) {
            transform: rotate(45deg) translate(6px, 6px);
            width: 100%;
        }
        
        .mobile-menu-toggle.active .hamburger span:nth-child(2) {
            opacity: 0;
            transform: scale(0);
        }
        
        .mobile-menu-toggle.active .hamburger span:nth-child(3) {
            transform: rotate(-45deg) translate(6px, -6px);
            width: 100%;
        }
        
        /* 향상된 오버레이 */
        .mobile-menu-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(0,0,0,0.6), rgba(0,0,0,0.4));
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 999;
            touch-action: manipulation;
            opacity: 0;
            transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .mobile-menu-overlay.active {
            opacity: 1;
        }
        
        /* 메뉴 패널 개선 */
        .mobile-menu-panel {
            position: fixed;
            top: 0;
            left: -100%;
            width: 85%;
            max-width: 350px;
            height: 100vh;
            background: var(--bg-primary);
            z-index: 1001;
            padding: 80px 20px 20px 20px;
            overflow-x: auto;
            transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border-right: 3px solid var(--border-color);
            box-shadow: 5px 0 25px rgba(0,0,0,0.3);
        }
        
        .mobile-menu-panel.active {
            left: 0;
        }
        
        /* 메뉴 헤더 */
        .mobile-menu-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 70px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-primary));
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .mobile-menu-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--text-primary);
            margin: 0;
        }
        
        .mobile-menu-close {
            display: none;
            width: 40px;
            height: 40px;
            background: transparent;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            position: relative;
            transition: all 0.3s ease;
            touch-action: manipulation;
        }
        
        .mobile-menu-close:hover {
            background: var(--button-hover);
            transform: rotate(90deg);
        }
        
        .mobile-menu-close:active {
            transform: rotate(90deg) scale(0.9);
        }
        
        .mobile-menu-close::before,
        .mobile-menu-close::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 2px;
            background: var(--text-primary);
            border-radius: 1px;
            transition: all 0.3s ease;
        }
        
        .mobile-menu-close::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }
        
        .mobile-menu-close::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }
        
        /* 메뉴 아이템 애니메이션 */
        .mobile-menu-item {
            opacity: 0;
            transform: translateX(-30px);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .mobile-menu-panel.active .mobile-menu-item {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* 스태거드 애니메이션 지연 */
        .mobile-menu-panel.active .mobile-menu-item:nth-child(1) { transition-delay: 0.1s; }
        .mobile-menu-panel.active .mobile-menu-item:nth-child(2) { transition-delay: 0.15s; }
        .mobile-menu-panel.active .mobile-menu-item:nth-child(3) { transition-delay: 0.2s; }
        .mobile-menu-panel.active .mobile-menu-item:nth-child(4) { transition-delay: 0.25s; }
        .mobile-menu-panel.active .mobile-menu-item:nth-child(5) { transition-delay: 0.3s; }
        .mobile-menu-panel.active .mobile-menu-item:nth-child(6) { transition-delay: 0.35s; }
        .mobile-menu-panel.active .mobile-menu-item:nth-child(7) { transition-delay: 0.4s; }
        
        /* 스와이프 진행률 표시 */
        .swipe-indicator {
            position: absolute;
            top: 50%;
            right: -3px;
            width: 3px;
            height: 60px;
            background: linear-gradient(to bottom, transparent, #4A9EFF, transparent);
            border-radius: 2px;
            transform: translateY(-50%) scaleY(0);
            transition: transform 0.2s ease;
            z-index: 1002;
        }
        
        .swipe-indicator.active {
            transform: translateY(-50%) scaleY(1);
        }
        
        /* 메뉴 그림자 효과 */
        .mobile-menu-panel::before {
            content: '';
            position: absolute;
            top: 0;
            right: -10px;
            width: 10px;
            height: 100%;
            background: linear-gradient(to right, rgba(0,0,0,0.1), transparent);
            pointer-events: none;
        }
        
        /* 바디 스크롤 락 */
        body.menu-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
        }
        
        /* 터치 피드백 향상 */
        .touch-feedback {
            position: relative;
            overflow: hidden;
        }
        
        .touch-feedback::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255,255,255,0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.3s ease, height 0.3s ease;
            pointer-events: none;
        }
        
        .touch-feedback:active::after {
            width: 200px;
            height: 200px;
        }
        
        /* 태블릿 스타일 (768px - 1024px) */
        @media screen and (max-width: 1024px) and (min-width: 768px) {
            .control-frame {
                width: 280px;
                font-size: 8pt;
            }
            
            .tk-button {
                font-size: 7pt;
                padding: 3px 6px;
                min-width: 50px;
            }
            
            .tk-scale {
                width: 160px;
                height: 18px;
            }
            
            .labelframe-title {
                font-size: 8pt;
            }
            
            .tk-label {
                font-size: 7pt;
            }
            
            .slider-value {
                font-size: 7pt;
            }
            
            .results-grid {
                font-size: 7pt;
            }
            
            #plot-area {
                min-height: calc(100vh - 100px);
            }
        }
        
        /* 모바일 스타일 (< 768px) */
        @media screen and (max-width: 767px) {
            body {
                padding: 0;
                font-size: 8pt;
            }
            
            .title-bar {
                padding: 6px;
                font-size: 9pt;
                text-align: center;
            }
            
            .main-window {
                flex-direction: column;
                min-height: calc(100vh - 40px);
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .mobile-menu-close {
                display: block;
            }
            
            .mobile-menu-header {
                display: flex;
            }
            
            .mobile-menu-panel {
                width: 85%;
                max-width: 350px;
                position: fixed;
                top: 0;
                left: -100%;
                height: 100vh;
                background: var(--bg-primary);
                z-index: 1001;
                padding: 80px 20px 20px 20px;
                overflow-x: auto;
                transition: left 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                border-right: 3px solid var(--border-color);
                box-shadow: 5px 0 25px rgba(0,0,0,0.3);
            }
            
            .mobile-menu-panel.active {
                left: 0;
            }
            
            .mobile-menu-overlay.active {
                display: block;
            }
            
            .plot-frame {
                width: 100%;
                margin: 5px;
                padding: 5px;
                min-height: calc(100vh - 60px);
            }
            
            /* 모바일 최적화 컨트롤 */
            .labelframe {
                margin: 6px 0;
                padding: 6px;
                border: 1px solid var(--border-color);
            }
            
            .labelframe-title {
                font-size: 9pt;
                font-weight: bold;
            }
            
            .tk-button {
                font-size: 9pt;
                padding: 8px 12px;
                min-width: 70px;
                margin: 3px;
                touch-action: manipulation;
            }
            
            .tk-scale {
                width: 100%;
                height: 25px;
                margin: 6px 0;
                touch-action: manipulation;
            }
            
            .tk-scale::-webkit-slider-thumb {
                width: 20px;
                height: 20px;
            }
            
            .tk-combobox {
                width: 100%;
                font-size: 9pt;
                padding: 8px;
                touch-action: manipulation;
            }
            
            .tk-label {
                font-size: 9pt;
                margin: 4px 0;
            }
            
            .slider-value {
                font-size: 9pt;
                font-weight: bold;
            }
            
            .button-group {
                flex-wrap: wrap;
                gap: 6px;
                justify-content: center;
            }
            
            .results-grid {
                font-size: 8pt;
                gap: 6px;
            }
            
            .result-label {
                font-weight: bold;
            }
            
            .result-value {
                font-size: 9pt;
            }
            
            /* 모바일 그래프 최적화 */
            #plot-area {
                min-height: calc(100vh - 80px);
                width: 100%;
            }
        }
        
        /* 초소형 모바일 (< 480px) */
        @media screen and (max-width: 479px) {
            
            .control-frame {
                padding: 50px 10px 10px 10px;
            }
            
            .tk-button {
                font-size: 8pt;
                padding: 6px 10px;
                min-width: 60px;
            }
            
            .button-group {
                flex-direction: column;
                align-items: stretch;
            }
            
            .button-group .tk-button {
                width: 100%;
                margin: 2px 0;
            }
            
            .results-grid {
                grid-template-columns: 1fr;
                text-align: center;
            }
            
            .result-label {
                text-align: center;
                padding-right: 0;
                margin-bottom: 2px;
            }
            
            .result-value {
                text-align: center;
                margin-bottom: 8px;
                font-weight: bold;
            }
        }
        
        /* 가로 모드 모바일 최적화 */
        @media screen and (max-width: 767px) and (orientation: landscape) {
            .main-window {
                flex-direction: row;
            }
            
            .mobile-menu-panel {
                width: 320px;
                max-width: 320px;
                height: 100vh;
                position: fixed;
                top: 0;
                left: -320px;
                padding: 70px 15px 15px 15px;
            }
            
            .mobile-menu-panel.active {
                left: 0;
            }
            
            .plot-frame {
                min-height: calc(100vh - 20px);
                margin-left: 10px;
            }
            
            /* 가로 모드에서 메뉴 헤더 높이 조정 */
            .mobile-menu-header {
                height: 60px;
            }
            
            .mobile-menu-title {
                font-size: 16px;
            }
        }
        
        /* 터치 디바이스 최적화 */
        @media (hover: none) and (pointer: coarse) {
            .tk-button:hover {
                background: var(--button-bg);
            }
            
            .tk-button:active {
                background: var(--button-active);
                transform: scale(0.98);
            }
            
            .tk-scale::-webkit-slider-thumb {
                cursor: grab;
            }
            
            .tk-scale::-webkit-slider-thumb:active {
                cursor: grabbing;
                transform: scale(1.2);
            }
        }
        
        /* 테마 전환 애니메이션 */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="title-bar">Ekman Transport Visualizer</div>
    
    <!-- 향상된 모바일 햄버거 메뉴 -->
    <button class="mobile-menu-toggle" onclick="toggleMobileMenu()" aria-label="메뉴 열기" aria-expanded="false">
        <div class="hamburger">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </button>
    <div class="mobile-menu-overlay" onclick="closeMobileMenu()" ontouchend="closeMobileMenu()"></div>
    
    <div class="main-window">
        <!-- 왼쪽 제어 패널 (Tkinter GUI와 동일한 레이아웃) -->
        <div class="control-frame mobile-menu-panel">
            <!-- 향상된 메뉴 헤더 -->
            <div class="mobile-menu-header">
                <h2 class="mobile-menu-title">⚙️ 제어판</h2>
                <button class="mobile-menu-close" onclick="closeMobileMenu()" aria-label="메뉴 닫기"></button>
            </div>
            
            <!-- 스와이프 진행률 표시 -->
            <div class="swipe-indicator"></div>
            
            <!-- 언어 선택 -->
            <div class="labelframe mobile-menu-item">
                <div class="labelframe-title">🌐 언어 선택</div>
                <label for="language" class="tk-label">Language:</label>
                <select id="language" class="tk-combobox">
                    <option value="en">English</option>
                    <option value="ko">한국어</option>
                    <option value="zh">中文</option>
                    <option value="ja">日本語</option>
                    <option value="es">Español</option>
                    <option value="ru">Русский</option>
                </select>
            </div>
            
            <!-- 파라미터 설정 -->
            <div class="labelframe mobile-menu-item">
                <div class="labelframe-title">🎛️ 파라미터 설정</div>
                
                <!-- 바람 속도 -->
                <div class="slider-container">
                    <label for="wind_speed" class="tk-label">🌬️ 바람 속도 (m/s):</label>
                    <input type="range" id="wind_speed" class="tk-scale" min="0" max="30" value="10" step="0.1">
                    <span class="slider-value" id="wind_speed_value">10.0</span>
                </div>
                
                <!-- 바람 방향 -->
                <div class="slider-container">
                    <label for="wind_direction" class="tk-label">🧭 바람 방향 (°):</label>
                    <input type="range" id="wind_direction" class="tk-scale" min="0" max="360" value="0" step="1">
                    <span class="slider-value" id="wind_direction_value">0</span>
                </div>
                
                <!-- 위도 -->
                <div class="slider-container">
                    <label for="latitude" class="tk-label">🌍 위도 (°):</label>
                    <input type="range" id="latitude" class="tk-scale" min="-90" max="90" value="30" step="1">
                    <span class="slider-value" id="latitude_value">30</span>
                </div>
                
                <!-- 깊이 -->
                <div class="slider-container">
                    <label for="depth" class="tk-label">🌊 깊이 (m):</label>
                    <input type="range" id="depth" class="tk-scale" min="10" max="500" value="100" step="10">
                    <span class="slider-value" id="depth_value">100</span>
                </div>
            </div>
            
            <!-- 시각화 타입 -->
            <div class="labelframe mobile-menu-item">
                <div class="labelframe-title">📊 시각화 타입</div>
                <div>
                    <input type="radio" id="vis_3d" name="vis_type" value="3d" checked class="tk-radiobutton">
                    <label for="vis_3d" class="tk-label" style="display: inline;">🔮 3D</label>
                </div>
                <div>
                    <input type="radio" id="vis_2d" name="vis_type" value="2d" class="tk-radiobutton">
                    <label for="vis_2d" class="tk-label" style="display: inline;">📈 2D</label>
                </div>
            </div>
            
            <!-- 사전 설정 -->
            <div class="labelframe mobile-menu-item">
                <div class="labelframe-title">⚡ 사전 설정</div>
                <div class="button-group">
                    <button class="tk-button touch-feedback" onclick="setPreset('normal')">🌤️ 일반</button>
                    <button class="tk-button touch-feedback" onclick="setPreset('strong')">💨 강풍</button>
                    <button class="tk-button touch-feedback" onclick="setPreset('typhoon')">🌪️ 태풍</button>
                </div>
            </div>
            
            <!-- 지역 선택 -->
            <div class="labelframe mobile-menu-item">
                <div class="labelframe-title">🗺️ 지역 선택</div>
                <select id="location" class="tk-combobox" aria-label="지역 선택">
                    <option value="custom">🎯 사용자 설정</option>
                    <option value="los_angeles">🇺🇸 로스앤젤레스</option>
                    <option value="busan">🇰🇷 부산</option>
                    <option value="north_pacific">🌊 북태평양</option>
                    <option value="north_atlantic">🌊 북대서양</option>
                    <option value="southern_ocean">🧊 남극해</option>
                    <option value="equator">🔆 적도</option>
                </select>
            </div>
            
            <!-- 계산 버튼 -->
            <div class="button-group mobile-menu-item" style="margin: 16px 0;">
                <button id="calculate-btn" class="tk-button touch-feedback" style="width: 140px; height: 30px; font-weight: bold;" onclick="calculateAndVisualize()">🔄 계산 및 시각화</button>
                <button id="export-btn" class="tk-button touch-feedback" style="width: 100px; height: 30px;" onclick="exportResults()">💾 내보내기</button>
            </div>
            
            <!-- 결과 표시 -->
            <div class="labelframe mobile-menu-item">
                <div class="labelframe-title">📋 계산 결과</div>
                <div class="results-grid">
                    <div class="result-label">💨 바람 응력:</div>
                    <div class="result-value" id="wind_stress">-</div>
                    
                    <div class="result-label">📏 에크만 깊이:</div>
                    <div class="result-value" id="ekman_depth">-</div>
                    
                    <div class="result-label">🌊 총 수송량:</div>
                    <div class="result-value" id="total_transport">-</div>
                    
                    <div class="result-label">⚡ 에너지 전달률:</div>
                    <div class="result-value" id="energy_transfer">-</div>
                </div>
            </div>
            
        </div>
        
        <!-- 오른쪽 플롯 영역 -->
        <div class="plot-frame">
            <div id="plot-area" style="width: 100%; height: 100%;">
                <div style="text-align: center; padding: 50px; color: #666;">
                    <p>계산 및 시각화 버튼을 클릭하세요</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- 에크만 수송 계산 및 시각화 JavaScript -->
    <script>
        // 전역 변수
        let currentResults = null;
        
        // 위치 데이터
        const LOCATIONS = {
            'los_angeles': {lat: 34.0, wind: 3.0, wind_dir: 270},
            'busan': {lat: 35.1, wind: 3.5, wind_dir: 135},
            'north_pacific': {lat: 45.0, wind: 6.0, wind_dir: 135},
            'north_atlantic': {lat: 50.0, wind: 8.0, wind_dir: 270},
            'southern_ocean': {lat: -60.0, wind: 11.0, wind_dir: 270},
            'equator': {lat: 2.0, wind: 2.0, wind_dir: 90}
        };
        
        // 물리 상수
        const RHO_WATER = 1025;  // kg/m³
        const RHO_AIR = 1.225;   // kg/m³
        const CD = 0.0013;       // 항력 계수
        const OMEGA = 7.2921e-5; // 지구 자전 각속도 (rad/s)
        
        // 슬라이더 값 업데이트
        function updateSliderValues() {
            document.getElementById('wind_speed_value').textContent = parseFloat(document.getElementById('wind_speed').value).toFixed(1);
            document.getElementById('wind_direction_value').textContent = parseFloat(document.getElementById('wind_direction').value).toFixed(0);
            document.getElementById('latitude_value').textContent = parseFloat(document.getElementById('latitude').value).toFixed(0);
            document.getElementById('depth_value').textContent = parseFloat(document.getElementById('depth').value).toFixed(0);
        }
        
        // 사전 설정
        function setPreset(type) {
            if (type === 'normal') {
                document.getElementById('wind_speed').value = 10.0;
                document.getElementById('wind_direction').value = 0;
                document.getElementById('latitude').value = 30;
                document.getElementById('depth').value = 100;
            } else if (type === 'strong') {
                document.getElementById('wind_speed').value = 20.0;
                document.getElementById('wind_direction').value = 45;
                document.getElementById('latitude').value = 45;
                document.getElementById('depth').value = 150;
            } else if (type === 'typhoon') {
                document.getElementById('wind_speed').value = 30.0;
                document.getElementById('wind_direction').value = 90;
                document.getElementById('latitude').value = 25;
                document.getElementById('depth').value = 200;
            }
            updateSliderValues();
        }
        
        // 지역 선택
        function onLocationSelect() {
            const selected = document.getElementById('location').value;
            if (selected !== 'custom' && LOCATIONS[selected]) {
                const loc = LOCATIONS[selected];
                document.getElementById('latitude').value = loc.lat;
                document.getElementById('wind_speed').value = loc.wind;
                document.getElementById('wind_direction').value = loc.wind_dir;
                updateSliderValues();
            }
        }
        
        // 코리올리 매개변수 계산
        function calculateCoriolisParameter(latitude) {
            return 2 * OMEGA * Math.sin(latitude * Math.PI / 180);
        }
        
        // 에크만 수송 계산
        function calculateEkmanTransport(windSpeed, windDirection, latitude, depth) {
            if (latitude === 0) latitude = 1e-6; // 0으로 나누기 방지
            
            const f = calculateCoriolisParameter(latitude);
            const windStress = RHO_AIR * CD * windSpeed * windSpeed;
            const windDirRad = windDirection * Math.PI / 180;
            
            const tauX = windStress * Math.cos(windDirRad);
            const tauY = windStress * Math.sin(windDirRad);
            
            const Mx = -tauY / (RHO_WATER * f);
            const My = tauX / (RHO_WATER * f);
            
            const K = 0.01; // 수직 난류 점성 계수
            const ekmanDepth = Math.PI * Math.sqrt(2 * K / Math.abs(f));
            
            // 에크만 나선 계산
            const zLevels = [];
            const uVel = [];
            const vVel = [];
            
            for (let i = 0; i < 50; i++) {
                const z = (depth / 49) * i;
                zLevels.push(z);
                
                const a = Math.sqrt(Math.abs(f) / (2 * K));
                const factor = Math.exp(-a * z) / (RHO_WATER * Math.sqrt(2 * K * Math.abs(f)));
                const cosAz = Math.cos(a * z);
                const sinAz = Math.sin(a * z);
                const sgnF = Math.sign(f);
                
                const u = factor * (tauX * cosAz - sgnF * tauY * sinAz);
                const v = factor * (sgnF * tauX * sinAz + tauY * cosAz);
                
                uVel.push(u);
                vVel.push(v);
            }
            
            const energyTransfer = tauX * uVel[0] + tauY * vVel[0];
            
            return {
                windSpeed, windDirection, latitude, depth,
                windStress, tauX, tauY, Mx, My, ekmanDepth,
                zLevels, uVel, vVel, f, energyTransfer
            };
        }
        
        // 테마 감지 함수
        function isDarkMode() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        }
        
        // 테마에 따른 색상 반환
        function getThemeColors() {
            const dark = isDarkMode();
            return {
                background: dark ? '#2b2b2b' : 'white',
                paper: dark ? '#1e1e1e' : 'white',
                text: dark ? '#ffffff' : '#000000',
                grid: dark ? '#404040' : 'lightgray',
                font: dark ? '#e0e0e0' : '#333333'
            };
        }
        
        // 모바일 디바이스 감지
        function isMobile() {
            return window.innerWidth <= 767;
        }
        
        // 태블릿 디바이스 감지
        function isTablet() {
            return window.innerWidth > 767 && window.innerWidth <= 1024;
        }
        
        // 향상된 모바일 메뉴 토글
        function toggleMobileMenu() {
            const menuPanel = document.querySelector('.mobile-menu-panel');
            const overlay = document.querySelector('.mobile-menu-overlay');
            const toggleButton = document.querySelector('.mobile-menu-toggle');
            const body = document.body;
            
            const isActive = menuPanel.classList.contains('active');
            
            if (!isActive) {
                // 메뉴 열기
                menuPanel.classList.add('active');
                overlay.classList.add('active');
                toggleButton.classList.add('active');
                body.classList.add('menu-open');
                toggleButton.setAttribute('aria-expanded', 'true');
                
                // 햄버거 메뉴 진동 피드백 (지원하는 디바이스에서)
                if (navigator.vibrate) {
                    navigator.vibrate(50);
                }
                
                // 메뉴가 열렸을 때 포커스 설정 (접근성 개선)
                setTimeout(() => {
                    const firstMenuItem = menuPanel.querySelector('.mobile-menu-item input, .mobile-menu-item select, .mobile-menu-item button');
                    if (firstMenuItem) firstMenuItem.focus();
                }, 400);
                
                console.log("📱 모바일 메뉴 열림");
                
            } else {
                // 메뉴 닫기
                closeMobileMenu();
            }
        }
        
        // 향상된 모바일 메뉴 닫기
        function closeMobileMenu() {
            const menuPanel = document.querySelector('.mobile-menu-panel');
            const overlay = document.querySelector('.mobile-menu-overlay');
            const toggleButton = document.querySelector('.mobile-menu-toggle');
            const body = document.body;
            
            menuPanel.classList.remove('active');
            overlay.classList.remove('active');
            toggleButton.classList.remove('active');
            body.classList.remove('menu-open');
            toggleButton.setAttribute('aria-expanded', 'false');
            
            // 메뉴가 닫혔을 때 햄버거 버튼에 포커스 (접근성 개선)
            setTimeout(() => {
                toggleButton.focus();
            }, 100);
            
            console.log("📱 모바일 메뉴 닫힘");
        }
        
        // 향상된 스와이프 제스처로 메뉴 닫기
        function setupSwipeGesture() {
            const menuPanel = document.querySelector('.mobile-menu-panel');
            const swipeIndicator = document.querySelector('.swipe-indicator');
            let startX = 0;
            let currentX = 0;
            let isDragging = false;
            let swipeStarted = false;
            
            menuPanel.addEventListener('touchstart', function(e) {
                startX = e.touches[0].clientX;
                isDragging = true;
                swipeStarted = false;
            }, { passive: true });
            
            menuPanel.addEventListener('touchmove', function(e) {
                if (!isDragging) return;
                currentX = e.touches[0].clientX;
                const diffX = currentX - startX;
                
                // 왼쪽으로 스와이프하는 경우 (메뉴 닫기)
                if (diffX < -30 && !swipeStarted) {
                    swipeStarted = true;
                    swipeIndicator.classList.add('active');
                    
                    // 진동 피드백
                    if (navigator.vibrate) {
                        navigator.vibrate(20);
                    }
                }
                
                if (swipeStarted && diffX < 0) {
                    const progress = Math.abs(diffX) / 150; // 150px 기준
                    const clampedProgress = Math.min(progress, 1);
                    
                    // 부드러운 변형 적용
                    const translateX = Math.max(diffX * 0.5, -200);
                    menuPanel.style.transform = `translateX(${translateX}px)`;
                    menuPanel.style.opacity = 1 - (clampedProgress * 0.3);
                    
                    // 스와이프 진행률에 따라 인디케이터 색상 변경
                    const hue = 240 - (clampedProgress * 60); // 파란색에서 빨간색으로
                    swipeIndicator.style.background = `linear-gradient(to bottom, transparent, hsl(${hue}, 70%, 60%), transparent)`;
                }
            }, { passive: true });
            
            menuPanel.addEventListener('touchend', function(e) {
                if (!isDragging) return;
                isDragging = false;
                swipeStarted = false;
                
                const diffX = currentX - startX;
                const swipeDistance = Math.abs(diffX);
                const swipeVelocity = swipeDistance / 300; // 간단한 속도 계산
                
                // 충분히 왼쪽으로 스와이프했거나 빠른 속도로 스와이프한 경우 메뉴 닫기
                if ((diffX < -100) || (diffX < -50 && swipeVelocity > 0.3)) {
                    // 성공적인 스와이프 피드백
                    if (navigator.vibrate) {
                        navigator.vibrate([30, 50, 30]);
                    }
                    
                    closeMobileMenu();
                    console.log(`📱 스와이프로 메뉴 닫기 (거리: ${swipeDistance.toFixed(0)}px, 속도: ${swipeVelocity.toFixed(2)})`);
                } else {
                    // 스와이프 취소 - 원래 위치로 복원
                    if (navigator.vibrate) {
                        navigator.vibrate(10);
                    }
                }
                
                // 변형 및 인디케이터 초기화
                menuPanel.style.transform = '';
                menuPanel.style.opacity = '';
                swipeIndicator.classList.remove('active');
                swipeIndicator.style.background = '';
                
            }, { passive: true });
            
            // 스와이프 취소 (터치가 메뉴 밖으로 나갔을 때)
            document.addEventListener('touchend', function(e) {
                if (isDragging && !menuPanel.contains(e.target)) {
                    isDragging = false;
                    swipeStarted = false;
                    menuPanel.style.transform = '';
                    menuPanel.style.opacity = '';
                    swipeIndicator.classList.remove('active');
                    swipeIndicator.style.background = '';
                }
            }, { passive: true });
        }
        
        // 모바일 최적화 2D 시각화 생성 (간단한 단일 차트)
        function createMobile2DPlot(results) {
            const colors = getThemeColors();
            const traces = [];
            
            // 모바일에서는 가장 중요한 정보만 간단히 표시
            // 에크만 나선 + 바람 벡터를 하나의 차트로
            
            // 1. 에크만 나선
            traces.push({
                x: results.uVel, 
                y: results.vVel,
                mode: 'lines+markers',
                line: {color: '#FF4081', width: 4},
                marker: {
                    size: 8,
                    color: results.zLevels,
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: {text: "깊이 (m)", font: {color: colors.text, size: 14}},
                        bgcolor: colors.background,
                        bordercolor: colors.grid,
                        tickfont: {color: colors.text, size: 12},
                        len: 0.6,
                        thickness: 20,
                        x: 1.02
                    }
                },
                name: '에크만 나선',
                hovertemplate: '깊이: %{marker.color:.1f}m<br>U: %{x:.4f}, V: %{y:.4f} m/s<extra></extra>'
            });
            
            // 2. 바람 벡터 (스케일 조정)
            const windDirRad = results.windDirection * Math.PI / 180;
            const windScale = Math.max(...results.uVel.map(Math.abs), ...results.vVel.map(Math.abs)) * 0.5;
            const windX = windScale * Math.cos(windDirRad);
            const windY = windScale * Math.sin(windDirRad);
            
            traces.push({
                x: [0, windX], 
                y: [0, windY],
                mode: 'lines+markers',
                line: {color: '#FF6B35', width: 6},
                marker: {size: 15, symbol: 'arrow', color: '#FF6B35'},
                name: `🌬️ 바람 ${results.windSpeed.toFixed(1)} m/s`,
                hovertemplate: `바람속도: ${results.windSpeed.toFixed(1)} m/s<br>방향: ${results.windDirection.toFixed(0)}°<extra></extra>`
            });
            
            // 3. 수송 벡터 (스케일 조정) 
            const transportScale = windScale * 0.3;
            traces.push({
                x: [0, results.Mx * transportScale / Math.abs(results.Mx || 1)], 
                y: [0, results.My * transportScale / Math.abs(results.My || 1)],
                mode: 'lines+markers',
                line: {color: '#4A9EFF', width: 5, dash: 'dash'},
                marker: {size: 12, symbol: 'arrow', color: '#4A9EFF'},
                name: `📊 수송 ${Math.sqrt(results.Mx**2 + results.My**2).toExponential(1)} m³/s`,
                hovertemplate: `수송량: ${Math.sqrt(results.Mx**2 + results.My**2).toExponential(2)} m³/s<extra></extra>`
            });
            
            const layout = {
                title: {
                    text: `🌊 에크만 수송 시각화<br>위도: ${results.latitude.toFixed(1)}°`,
                    font: {color: colors.text, size: 16},
                    x: 0.5,
                    y: 0.95
                },
                xaxis: {
                    title: {text: 'U 속도 (동-서, m/s)', font: {color: colors.text, size: 12}},
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text, size: 11},
                    linecolor: colors.grid,
                    zeroline: true,
                    zerolinecolor: colors.grid
                },
                yaxis: {
                    title: {text: 'V 속도 (남-북, m/s)', font: {color: colors.text, size: 12}},
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text, size: 11},
                    linecolor: colors.grid,
                    zeroline: true,
                    zerolinecolor: colors.grid
                },
                height: 600,
                showlegend: true,
                legend: {
                    font: {color: colors.text, size: 11},
                    bgcolor: 'rgba(0,0,0,0)',
                    x: 0.02,
                    y: 0.98
                },
                font: {size: 11, color: colors.text},
                plot_bgcolor: colors.background,
                paper_bgcolor: colors.paper,
                margin: {l: 60, r: 80, t: 80, b: 60}
            };
            
            return {data: traces, layout: layout};
        }
        
        // 2D 시각화 생성
        function create2DPlot(results) {
            const traces = [];
            const colors = getThemeColors();
            
            // 1. 바람 vs 수송 벡터
            const windDirRad = results.windDirection * Math.PI / 180;
            const windX = results.windSpeed * Math.cos(windDirRad);
            const windY = results.windSpeed * Math.sin(windDirRad);
            
            traces.push({
                x: [0, windX], y: [0, windY],
                mode: 'lines+markers',
                line: {color: '#FF6B35', width: 4},
                marker: {size: 10},
                name: `바람 ${results.windSpeed.toFixed(1)} m/s`,
                xaxis: 'x', yaxis: 'y'
            });
            
            const transportScale = 1e6;
            traces.push({
                x: [0, results.Mx * transportScale], 
                y: [0, results.My * transportScale],
                mode: 'lines+markers',
                line: {color: '#4A9EFF', width: 4},
                marker: {size: 10},
                name: `수송 ${Math.sqrt(results.Mx**2 + results.My**2).toExponential(2)} m³/s`,
                xaxis: 'x', yaxis: 'y'
            });
            
            // 2. 에크만 나선
            traces.push({
                x: results.uVel, y: results.vVel,
                mode: 'lines+markers',
                line: {color: '#FF4081', width: 3},
                marker: {
                    size: 6,
                    color: results.zLevels,
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: {text: "깊이 (m)", font: {color: colors.text}}, 
                        x: 0.48, y: 0.75, len: 0.25,
                        bgcolor: colors.background,
                        bordercolor: colors.grid,
                        tickfont: {color: colors.text}
                    }
                },
                name: '에크만 나선',
                xaxis: 'x2', yaxis: 'y2'
            });
            
            // 3. 깊이별 속도 프로파일
            traces.push({
                x: results.uVel, y: results.zLevels.map(z => -z),
                mode: 'lines+markers',
                line: {color: '#1F77B4', width: 3},
                marker: {size: 4},
                name: 'U 속도 (동-서)',
                xaxis: 'x3', yaxis: 'y3'
            });
            
            traces.push({
                x: results.vVel, y: results.zLevels.map(z => -z),
                mode: 'lines+markers',
                line: {color: '#FF7F0E', width: 3},
                marker: {size: 4},
                name: 'V 속도 (남-북)',
                xaxis: 'x3', yaxis: 'y3'
            });
            
            // 4. 수송 성분 바 차트
            traces.push({
                x: ['Mx (동-서)', 'My (남-북)'],
                y: [results.Mx, results.My],
                type: 'bar',
                marker: {color: ['#1F77B4', '#FF7F0E']},
                name: '수송 성분',
                xaxis: 'x4', yaxis: 'y4'
            });
            
            const layout = {
                title: {
                    text: `🌊 에크만 수송 분석 (위도: ${results.latitude.toFixed(1)}°)`,
                    font: {color: colors.text, size: 16}
                },
                grid: {rows: 2, columns: 2, pattern: 'independent'},
                
                // 모든 축 스타일링
                xaxis: {
                    title: {text: '동-서 방향 (m/s)', font: {color: colors.text}}, 
                    domain: [0, 0.45],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                yaxis: {
                    title: {text: '남-북 방향 (m/s)', font: {color: colors.text}}, 
                    domain: [0.55, 1],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                xaxis2: {
                    title: {text: 'U 속도 (m/s)', font: {color: colors.text}}, 
                    domain: [0.55, 1],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                yaxis2: {
                    title: {text: 'V 속도 (m/s)', font: {color: colors.text}}, 
                    domain: [0.55, 1],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                xaxis3: {
                    title: {text: '속도 (m/s)', font: {color: colors.text}}, 
                    domain: [0, 0.45],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                yaxis3: {
                    title: {text: '깊이 (m)', font: {color: colors.text}}, 
                    domain: [0, 0.45],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                xaxis4: {
                    title: {text: '성분', font: {color: colors.text}}, 
                    domain: [0.55, 1],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                yaxis4: {
                    title: {text: '수송량 (m³/s)', font: {color: colors.text}}, 
                    domain: [0, 0.45],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                
                height: 800,
                showlegend: true,
                font: {size: 12, color: colors.text},
                plot_bgcolor: colors.background,
                paper_bgcolor: colors.paper,
                legend: {
                    font: {color: colors.text},
                    bgcolor: 'rgba(0,0,0,0)'
                }
            };
            
            return {data: traces, layout: layout};
        }
        
        // 3D 시각화 생성
        function create3DPlot(results) {
            const traces = [];
            const colors = getThemeColors();
            const speeds = results.uVel.map((u, i) => Math.sqrt(u*u + results.vVel[i]*results.vVel[i]));
            
            // 에크만 나선 3D
            traces.push({
                x: results.uVel,
                y: results.vVel,
                z: results.zLevels.map(z => -z),
                mode: 'lines+markers',
                type: 'scatter3d',
                line: {
                    color: speeds,
                    colorscale: 'Viridis',
                    width: 8,
                    colorbar: {
                        title: {
                            text: "속도 크기 (m/s)", 
                            font: {color: colors.text, size: 16},
                            side: 'right'
                        },
                        bgcolor: colors.background,
                        bordercolor: colors.grid,
                        borderwidth: 2,
                        tickfont: {color: colors.text, size: 14},
                        len: 0.8,
                        thickness: 25,
                        x: 1.02,
                        xanchor: 'left',
                        y: 0.5,
                        yanchor: 'middle'
                    }
                },
                marker: {size: 4, color: speeds, colorscale: 'Viridis'},
                name: '에크만 나선'
            });
            
            // 바람 벡터
            const windDirRad = results.windDirection * Math.PI / 180;
            const windX = results.windSpeed * Math.cos(windDirRad) * 0.01;
            const windY = results.windSpeed * Math.sin(windDirRad) * 0.01;
            
            traces.push({
                x: [0, windX], y: [0, windY], z: [10, 10],
                mode: 'lines+markers',
                type: 'scatter3d',
                line: {color: '#FF6B35', width: 10},
                marker: {size: 8, color: '#FF6B35'},
                name: `🌬️ 바람 ${results.windSpeed.toFixed(1)} m/s`
            });
            
            // 에크만 깊이별 벡터 필드 표시
            const step = Math.max(1, Math.floor(results.zLevels.length / 8));
            for (let i = 0; i < results.zLevels.length; i += step) {
                const scale = 0.02;
                const alpha = 0.6;
                traces.push({
                    x: [0, results.uVel[i] * scale],
                    y: [0, results.vVel[i] * scale],
                    z: [-results.zLevels[i], -results.zLevels[i]],
                    mode: 'lines',
                    type: 'scatter3d',
                    line: {
                        color: `rgba(${isDarkMode() ? '100, 149, 237' : '30, 144, 255'}, ${alpha})`,
                        width: 4
                    },
                    showlegend: false,
                    hovertemplate: `깊이: ${results.zLevels[i].toFixed(1)}m<br>속도: ${speeds[i].toFixed(4)} m/s<extra></extra>`
                });
            }
            
            const layout = {
                title: {
                    text: `🌊 3D 에크만 수송 시각화 (위도: ${results.latitude.toFixed(1)}°)`,
                    font: {color: colors.text, size: 18},
                    x: 0.5,
                    y: 0.95
                },
                scene: {
                    bgcolor: colors.background,
                    xaxis: {
                        title: {text: 'U 속도 (동-서, m/s)', font: {color: colors.text, size: 14}},
                        gridcolor: colors.grid,
                        tickfont: {color: colors.text, size: 12},
                        linecolor: colors.grid,
                        backgroundcolor: colors.background
                    },
                    yaxis: {
                        title: {text: 'V 속도 (남-북, m/s)', font: {color: colors.text, size: 14}},
                        gridcolor: colors.grid,
                        tickfont: {color: colors.text, size: 12},
                        linecolor: colors.grid,
                        backgroundcolor: colors.background
                    },
                    zaxis: {
                        title: {text: '깊이 (m)', font: {color: colors.text, size: 14}},
                        gridcolor: colors.grid,
                        tickfont: {color: colors.text, size: 12},
                        linecolor: colors.grid,
                        backgroundcolor: colors.background
                    },
                    camera: {
                        eye: {x: 1.8, y: 1.8, z: 1.5}
                    },
                    aspectmode: 'cube'
                },
                autosize: true,
                width: null,
                height: null,
                margin: {l: 0, r: 0, t: 60, b: 0},
                font: {size: 14, color: colors.text},
                plot_bgcolor: colors.background,
                paper_bgcolor: colors.paper,
                legend: {
                    font: {color: colors.text, size: 12},
                    bgcolor: 'rgba(0,0,0,0)',
                    x: 0.02,
                    y: 0.98
                }
            };
            
            return {data: traces, layout: layout};
        }
        
        // 메인 계산 및 시각화 함수
        function calculateAndVisualize() {
            try {
                console.log("🔄 계산 시작...");
                
                const windSpeed = parseFloat(document.getElementById('wind_speed').value);
                const windDirection = parseFloat(document.getElementById('wind_direction').value);
                let latitude = parseFloat(document.getElementById('latitude').value);
                const depth = parseFloat(document.getElementById('depth').value);
                
                if (latitude === 0) {
                    latitude = 1;
                    document.getElementById('latitude').value = 1;
                    updateSliderValues();
                }
                
                const results = calculateEkmanTransport(windSpeed, windDirection, latitude, depth);
                currentResults = results;
                
                const visType = document.querySelector('input[name="vis_type"]:checked').value;
                
                let plotData;
                let config;
                
                if (isMobile()) {
                    // 모바일 최적화
                    if (visType === '3d') {
                        plotData = create3DPlot(results);
                    } else {
                        plotData = createMobile2DPlot(results);
                    }
                    
                    config = {
                        displayModeBar: true,
                        displaylogo: false,
                        responsive: true,
                        scrollZoom: true,
                        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d'],
                        modeBarButtonsToAdd: ['downloadpng'],
                        toImageButtonOptions: {
                            format: 'png',
                            filename: 'ekman_transport_mobile',
                            height: 800,
                            width: 600,
                            scale: 2
                        },
                        // 모바일 터치 최적화
                        doubleClick: 'reset',
                        touchAction: 'auto'
                    };
                    
                    // 모바일에서 계산 후 메뉴 자동 닫기 (부드러운 애니메이션)
                    setTimeout(() => {
                        closeMobileMenu();
                        
                        // 성공 피드백
                        if (navigator.vibrate) {
                            navigator.vibrate([100, 50, 100]);
                        }
                        
                        console.log("📱 계산 완료 - 메뉴 자동 닫기");
                    }, 800);
                    
                } else if (isTablet()) {
                    // 태블릿 최적화
                    if (visType === '3d') {
                        plotData = create3DPlot(results);
                    } else {
                        plotData = create2DPlot(results);
                    }
                    
                    config = {
                        displayModeBar: true,
                        displaylogo: false,
                        responsive: true,
                        modeBarButtonsToAdd: ['downloadpng'],
                        toImageButtonOptions: {
                            format: 'png',
                            filename: 'ekman_transport_tablet',
                            height: 900,
                            width: 1200,
                            scale: 2
                        }
                    };
                    
                } else {
                    // 데스크톱 (기존)
                    if (visType === '3d') {
                        plotData = create3DPlot(results);
                    } else {
                        plotData = create2DPlot(results);
                    }
                    
                    config = {
                        displayModeBar: true,
                        displaylogo: false,
                        responsive: true,
                        modeBarButtonsToAdd: ['downloadpng'],
                        toImageButtonOptions: {
                            format: 'png',
                            filename: 'ekman_transport_plot',
                            height: 1000,
                            width: 1600,
                            scale: 2
                        }
                    };
                }
                
                document.getElementById('plot-area').innerHTML = '';
                Plotly.newPlot('plot-area', plotData.data, plotData.layout, config);
                
                // 화면 크기 변경 시 자동 리사이즈 및 레이아웃 재구성
                window.addEventListener('resize', function() {
                    Plotly.Plots.resize('plot-area');
                    handleWindowResize();
                });
                
                updateResultsDisplay(results);
                
                console.log("✅ 계산 및 시각화 완료!");
                
            } catch (error) {
                console.error("❌ 오류 발생:", error);
                document.getElementById('plot-area').innerHTML = 
                    `<div style="color: red; text-align: center; padding: 50px; font-size: 16px;">
                        오류: ${error.message}<br>파라미터를 확인해주세요.
                    </div>`;
            }
        }
        
        // 결과 표시 업데이트
        function updateResultsDisplay(results) {
            document.getElementById('wind_stress').textContent = 
                `${(results.windStress * 1000).toFixed(3)} mN/m²`;
            document.getElementById('ekman_depth').textContent = 
                `${results.ekmanDepth.toFixed(2)} m`;
            
            const totalTransport = Math.sqrt(results.Mx**2 + results.My**2);
            document.getElementById('total_transport').textContent = 
                `${totalTransport.toExponential(3)} m³/s`;
            document.getElementById('energy_transfer').textContent = 
                `${(results.energyTransfer * 1000).toFixed(4)} mW/m²`;
        }
        
        // 내보내기
        function exportResults() {
            if (!currentResults) {
                console.log("❌ 먼저 계산을 수행하세요.");
                return;
            }
            
            const exportData = {
                '입력 파라미터': {
                    '바람속도 (m/s)': currentResults.windSpeed,
                    '바람방향 (°)': currentResults.windDirection,
                    '위도 (°)': currentResults.latitude,
                    '깊이 (m)': currentResults.depth
                },
                '계산 결과': {
                    '바람응력 (N/m²)': currentResults.windStress.toExponential(6),
                    '에크만깊이 (m)': currentResults.ekmanDepth.toFixed(2),
                    'Mx 수송 (m³/s)': currentResults.Mx.toExponential(6),
                    'My 수송 (m³/s)': currentResults.My.toExponential(6),
                    '총 수송량 (m³/s)': Math.sqrt(currentResults.Mx**2 + currentResults.My**2).toExponential(6),
                    '에너지전달률 (W/m²)': currentResults.energyTransfer.toExponential(6),
                    '코리올리 매개변수': currentResults.f.toExponential(6)
                }
            };
            
            console.log("📊 내보내기 데이터:");
            console.log(JSON.stringify(exportData, null, 2));
        }
        
                // 테마 변경 감지 및 차트 업데이트 (디바이스별 최적화)
        function handleThemeChange() {
            if (currentResults) {
                const visType = document.querySelector('input[name="vis_type"]:checked').value;
                let plotData;
                let config;
                
                // 디바이스별 차트 선택
                if (isMobile()) {
                    if (visType === '3d') {
                        plotData = create3DPlot(currentResults);
                    } else {
                        plotData = createMobile2DPlot(currentResults);
                    }
                    config = {
                        displayModeBar: true,
                        displaylogo: false,
                        responsive: true,
                        scrollZoom: true,
                        doubleClick: 'reset',
                        touchAction: 'auto'
                    };
                } else if (isTablet()) {
                    if (visType === '3d') {
                        plotData = create3DPlot(currentResults);
                    } else {
                        plotData = create2DPlot(currentResults);
                    }
                    config = {
                        displayModeBar: true,
                        displaylogo: false,
                        responsive: true
                    };
                } else {
                    if (visType === '3d') {
                        plotData = create3DPlot(currentResults);
                    } else {
                        plotData = create2DPlot(currentResults);
                    }
                    config = {
                        displayModeBar: true,
                        displaylogo: false,
                        responsive: true
                    };
                }
                
                Plotly.newPlot('plot-area', plotData.data, plotData.layout, config);
                
                // 차트 리사이즈 적용
                setTimeout(() => {
                    Plotly.Plots.resize('plot-area');
                }, 100);
                
                console.log(`🎨 테마 변경 - ${isMobile() ? '모바일' : isTablet() ? '태블릿' : '데스크톱'} 최적화 적용!`);
            }
        }
        
        // 윈도우 리사이즈 감지 및 적응형 레이아웃
        function handleWindowResize() {
            if (currentResults) {
                // 디바이스 타입이 변경되었을 때 차트 재구성
                setTimeout(() => {
                    handleThemeChange();
                }, 200);
            }
        }
        
        // 이벤트 리스너 설정
        document.addEventListener('DOMContentLoaded', function() {
            // 슬라이더 이벤트
            ['wind_speed', 'wind_direction', 'latitude', 'depth'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSliderValues);
            });
            
            // 지역 선택 이벤트
            document.getElementById('location').addEventListener('change', onLocationSelect);
            
            // 키보드 이벤트 (ESC로 메뉴 닫기, Enter로 메뉴 열기)
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const menuPanel = document.querySelector('.mobile-menu-panel');
                    if (menuPanel && menuPanel.classList.contains('active')) {
                        closeMobileMenu();
                        e.preventDefault();
                    }
                }
                
                // 햄버거 버튼에 포커스가 있을 때 Enter/Space로 메뉴 토글
                if ((e.key === 'Enter' || e.key === ' ') && e.target.classList.contains('mobile-menu-toggle')) {
                    toggleMobileMenu();
                    e.preventDefault();
                }
            });
            
            // 모바일 스와이프 제스처 설정
            if (isMobile()) {
                setupSwipeGesture();
            }
            
            // 시스템 테마 변경 감지
            if (window.matchMedia) {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', handleThemeChange);
                
                // 초기 테마 상태 로그
                console.log(`🎨 현재 테마: ${isDarkMode() ? '다크 모드' : '라이트 모드'}`);
            }
            
            // 시각화 타입 변경 이벤트
            document.querySelectorAll('input[name="vis_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (currentResults) {
                        handleThemeChange(); // 디바이스별 최적화된 차트 렌더링
                    }
                });
            });
            
            // 윈도우 리사이즈 이벤트 (디바이스 변경 감지)
            window.addEventListener('resize', handleWindowResize);
            
            // 모바일 터치 이벤트 최적화
            if (isMobile()) {
                // 모바일에서 드래그 시 페이지 스크롤 방지
                document.addEventListener('touchmove', function(e) {
                    if (e.target.closest('#plot-area')) {
                        e.preventDefault();
                    }
                }, { passive: false });
                
                console.log("📱 모바일 최적화 모드 활성화");
            } else if (isTablet()) {
                console.log("📱 태블릿 최적화 모드 활성화");
            } else {
                console.log("🖥️ 데스크톱 모드 활성화");
            }
            
            // 초기값 설정
            updateSliderValues();
            
            console.log("🌊 Ekman Transport Visualizer 로드 완료!");
            console.log("📊 파이썬 스타일 시각화가 준비되었습니다.");
            console.log("🌗 자동 다크/라이트 모드 전환이 활성화되었습니다.");
            console.log("📱 반응형 디자인 (데스크톱/태블릿/모바일) 지원");
        });
    </script>
</body>
</html> 