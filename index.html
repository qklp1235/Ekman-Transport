<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ekman Transport Visualizer</title>
    
    <!-- ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ ìë™ ì „í™˜ CSS -->
    <style>
        /* CSS ë³€ìˆ˜ë¡œ í…Œë§ˆ ì •ì˜ */
        :root {
            --bg-primary: #f0f0f0;
            --bg-secondary: white;
            --border-color: #d0d0d0;
            --text-primary: #000;
            --text-secondary: #333;
            --button-bg: linear-gradient(to bottom, #f0f0f0 0%, #e0e0e0 100%);
            --button-hover: linear-gradient(to bottom, #f5f5f5 0%, #e5e5e5 100%);
            --button-active: linear-gradient(to bottom, #e0e0e0 0%, #f0f0f0 100%);
            --input-bg: white;
            --slider-bg: #e0e0e0;
            --plot-bg: white;
            --chart-bg: white;
            --chart-grid: lightgray;
        }
        
        /* ë‹¤í¬ ëª¨ë“œ í…Œë§ˆ */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-primary: #2b2b2b;
                --bg-secondary: #1e1e1e;
                --border-color: #404040;
                --text-primary: #ffffff;
                --text-secondary: #e0e0e0;
                --button-bg: linear-gradient(to bottom, #404040 0%, #303030 100%);
                --button-hover: linear-gradient(to bottom, #4a4a4a 0%, #3a3a3a 100%);
                --button-active: linear-gradient(to bottom, #303030 0%, #404040 100%);
                --input-bg: #2d2d2d;
                --slider-bg: #404040;
                --plot-bg: #1e1e1e;
                --chart-bg: #2b2b2b;
                --chart-grid: #404040;
            }
        }
        
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ (í…Œë§ˆ ë³€ìˆ˜ ì‚¬ìš©) */
        body {
            font-family: 'Segoe UI', 'Arial', sans-serif;
            font-size: 9pt;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            margin: 0;
            padding: 8px;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        .main-window {
            background-color: var(--bg-primary);
            border: 1px solid var(--border-color);
            display: flex;
            min-height: calc(100vh - 16px);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* ì™¼ìª½ ì œì–´ íŒ¨ë„ */
        .control-frame {
            width: 320px;
            background-color: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            padding: 10px;
            overflow-y: auto;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .labelframe {
            border: 2px groove var(--border-color);
            margin: 8px 0;
            padding: 8px;
            background-color: var(--bg-primary);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .labelframe-title {
            font-weight: bold;
            font-size: 9pt;
            color: var(--text-primary);
            background-color: var(--bg-primary);
            padding: 0 4px;
            margin-left: 8px;
            position: relative;
            top: -16px;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .tk-button {
            background: var(--button-bg);
            border: 1px outset var(--border-color);
            color: var(--text-primary);
            padding: 4px 8px;
            margin: 2px;
            font-size: 8pt;
            cursor: pointer;
            min-width: 60px;
            font-family: 'Segoe UI', Arial, sans-serif;
            transition: all 0.3s ease;
        }
        
        .tk-button:hover {
            background: var(--button-hover);
            border-color: var(--border-color);
        }
        
        .tk-button:active {
            border: 1px inset var(--border-color);
            background: var(--button-active);
        }
        
        /* ë¼ë²¨ ìŠ¤íƒ€ì¼ */
        .tk-label {
            font-size: 8pt;
            color: var(--text-primary);
            margin: 2px 0;
            background-color: var(--bg-primary);
            display: block;
            transition: color 0.3s ease, background-color 0.3s ease;
        }
        
        /* ìŠ¬ë¼ì´ë” ìŠ¤íƒ€ì¼ */
        .tk-scale {
            width: 200px;
            height: 20px;
            margin: 4px 0;
            background: var(--slider-bg);
            border: 1px inset var(--border-color);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        .tk-scale::-webkit-slider-thumb {
            width: 16px;
            height: 16px;
            background: var(--button-bg);
            border: 1px outset var(--border-color);
            cursor: pointer;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        /* ì½¤ë³´ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .tk-combobox {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px inset var(--border-color);
            padding: 2px;
            font-size: 8pt;
            width: 150px;
            transition: all 0.3s ease;
        }
        
        /* ë¼ë””ì˜¤ ë²„íŠ¼ */
        .tk-radiobutton {
            font-size: 8pt;
            margin: 2px 0;
            background-color: var(--bg-primary);
            transition: background-color 0.3s ease;
        }
        
        /* ì˜¤ë¥¸ìª½ í”Œë¡¯ ì˜ì—­ */
        .plot-frame {
            flex: 1;
            background-color: var(--plot-bg);
            border: 2px groove var(--border-color);
            margin: 5px;
            padding: 5px;
            min-height: calc(100vh - 100px);
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        
        /* ê²°ê³¼ í‘œì‹œ ì˜ì—­ */
        .results-grid {
            display: grid;
            grid-template-columns: auto auto;
            gap: 4px;
            font-size: 8pt;
        }
        
        .result-label {
            text-align: right;
            padding-right: 8px;
            font-weight: normal;
            color: var(--text-secondary);
            transition: color 0.3s ease;
        }
        
        .result-value {
            text-align: left;
            font-family: 'Courier New', monospace;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin: 4px 0;
        }
        
        /* ìŠ¬ë¼ì´ë” ì»¨í…Œì´ë„ˆ */
        .slider-container {
            margin: 8px 0;
        }
        
        .slider-value {
            font-family: 'Courier New', monospace;
            font-size: 8pt;
            margin-left: 8px;
            color: var(--text-primary);
            transition: color 0.3s ease;
        }
        
        /* ì œëª© ë°” */
        .title-bar {
            background-color: var(--bg-primary);
            border-bottom: 1px solid var(--border-color);
            padding: 8px;
            font-weight: bold;
            font-size: 10pt;
            color: var(--text-primary);
            transition: all 0.3s ease;
        }
        
        /* ë‹¤í¬ ëª¨ë“œì—ì„œ ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
        @media (prefers-color-scheme: dark) {
            ::-webkit-scrollbar {
                width: 12px;
            }
            
            ::-webkit-scrollbar-track {
                background: var(--bg-primary);
            }
            
            ::-webkit-scrollbar-thumb {
                background: var(--border-color);
                border-radius: 6px;
            }
            
            ::-webkit-scrollbar-thumb:hover {
                background: #555;
            }
        }
        
        /* ë‹¤í¬ ëª¨ë“œì—ì„œ ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
        @media (prefers-color-scheme: dark) {
            input[type="range"] {
                accent-color: #4a9eff;
            }
            
            option {
                background-color: var(--input-bg);
                color: var(--text-primary);
            }
        }
        
        /* í”Œë¡¯ ì˜ì—­ ìµœì í™” */
        #plot-area {
            width: 100% !important;
            height: 100% !important;
            min-height: calc(100vh - 120px);
        }
        
        /* Plotly ì°¨íŠ¸ ì»¨í…Œì´ë„ˆ ìµœì í™” */
        .plot-container {
            width: 100% !important;
            height: 100% !important;
        }
        
        /* í…Œë§ˆ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="title-bar">Ekman Transport Visualizer</div>
    
    <div class="main-window">
        <!-- ì™¼ìª½ ì œì–´ íŒ¨ë„ (Tkinter GUIì™€ ë™ì¼í•œ ë ˆì´ì•„ì›ƒ) -->
        <div class="control-frame">
            
            <!-- ì–¸ì–´ ì„ íƒ -->
            <div class="labelframe">
                <div class="labelframe-title">ì–¸ì–´ ì„ íƒ</div>
                <label for="language" class="tk-label">Language:</label>
                <select id="language" class="tk-combobox">
                    <option value="en">English</option>
                    <option value="ko">í•œêµ­ì–´</option>
                    <option value="zh">ä¸­æ–‡</option>
                    <option value="ja">æ—¥æœ¬èª</option>
                    <option value="es">EspaÃ±ol</option>
                    <option value="ru">Ğ ÑƒÑÑĞºĞ¸Ğ¹</option>
                </select>
            </div>
            
            <!-- íŒŒë¼ë¯¸í„° ì„¤ì • -->
            <div class="labelframe">
                <div class="labelframe-title">íŒŒë¼ë¯¸í„° ì„¤ì •</div>
                
                <!-- ë°”ëŒ ì†ë„ -->
                <div class="slider-container">
                    <label for="wind_speed" class="tk-label">ë°”ëŒ ì†ë„ (m/s):</label>
                    <input type="range" id="wind_speed" class="tk-scale" min="0" max="30" value="10" step="0.1">
                    <span class="slider-value" id="wind_speed_value">10.0</span>
                </div>
                
                <!-- ë°”ëŒ ë°©í–¥ -->
                <div class="slider-container">
                    <label for="wind_direction" class="tk-label">ë°”ëŒ ë°©í–¥ (Â°):</label>
                    <input type="range" id="wind_direction" class="tk-scale" min="0" max="360" value="0" step="1">
                    <span class="slider-value" id="wind_direction_value">0</span>
                </div>
                
                <!-- ìœ„ë„ -->
                <div class="slider-container">
                    <label for="latitude" class="tk-label">ìœ„ë„ (Â°):</label>
                    <input type="range" id="latitude" class="tk-scale" min="-90" max="90" value="30" step="1">
                    <span class="slider-value" id="latitude_value">30</span>
                </div>
                
                <!-- ê¹Šì´ -->
                <div class="slider-container">
                    <label for="depth" class="tk-label">ê¹Šì´ (m):</label>
                    <input type="range" id="depth" class="tk-scale" min="10" max="500" value="100" step="10">
                    <span class="slider-value" id="depth_value">100</span>
                </div>
            </div>
            
            <!-- ì‹œê°í™” íƒ€ì… -->
            <div class="labelframe">
                <div class="labelframe-title">ì‹œê°í™” íƒ€ì…</div>
                <div>
                    <input type="radio" id="vis_3d" name="vis_type" value="3d" checked class="tk-radiobutton">
                    <label for="vis_3d" class="tk-label" style="display: inline;">3D</label>
                </div>
                <div>
                    <input type="radio" id="vis_2d" name="vis_type" value="2d" class="tk-radiobutton">
                    <label for="vis_2d" class="tk-label" style="display: inline;">2D</label>
                </div>
            </div>
            
            <!-- ì‚¬ì „ ì„¤ì • -->
            <div class="labelframe">
                <div class="labelframe-title">ì‚¬ì „ ì„¤ì •</div>
                <div class="button-group">
                    <button class="tk-button" onclick="setPreset('normal')">ì¼ë°˜</button>
                    <button class="tk-button" onclick="setPreset('strong')">ê°•í’</button>
                    <button class="tk-button" onclick="setPreset('typhoon')">íƒœí’</button>
                </div>
            </div>
            
            <!-- ì§€ì—­ ì„ íƒ -->
            <div class="labelframe">
                <div class="labelframe-title">ì§€ì—­ ì„ íƒ</div>
                <select id="location" class="tk-combobox" aria-label="ì§€ì—­ ì„ íƒ">
                    <option value="custom">ì‚¬ìš©ì ì„¤ì •</option>
                    <option value="los_angeles">ë¡œìŠ¤ì•¤ì ¤ë ˆìŠ¤</option>
                    <option value="busan">ë¶€ì‚°</option>
                    <option value="north_pacific">ë¶íƒœí‰ì–‘</option>
                    <option value="north_atlantic">ë¶ëŒ€ì„œì–‘</option>
                    <option value="southern_ocean">ë‚¨ê·¹í•´</option>
                    <option value="equator">ì ë„</option>
                </select>
            </div>
            
            <!-- ê³„ì‚° ë²„íŠ¼ -->
            <div class="button-group" style="margin: 16px 0;">
                <button id="calculate-btn" class="tk-button" style="width: 140px; height: 30px; font-weight: bold;" onclick="calculateAndVisualize()">ê³„ì‚° ë° ì‹œê°í™”</button>
                <button id="export-btn" class="tk-button" style="width: 100px; height: 30px;" onclick="exportResults()">ë‚´ë³´ë‚´ê¸°</button>
            </div>
            
            <!-- ê²°ê³¼ í‘œì‹œ -->
            <div class="labelframe">
                <div class="labelframe-title">ê³„ì‚° ê²°ê³¼</div>
                <div class="results-grid">
                    <div class="result-label">ë°”ëŒ ì‘ë ¥:</div>
                    <div class="result-value" id="wind_stress">-</div>
                    
                    <div class="result-label">ì—í¬ë§Œ ê¹Šì´:</div>
                    <div class="result-value" id="ekman_depth">-</div>
                    
                    <div class="result-label">ì´ ìˆ˜ì†¡ëŸ‰:</div>
                    <div class="result-value" id="total_transport">-</div>
                    
                    <div class="result-label">ì—ë„ˆì§€ ì „ë‹¬ë¥ :</div>
                    <div class="result-value" id="energy_transfer">-</div>
                </div>
            </div>
            
        </div>
        
        <!-- ì˜¤ë¥¸ìª½ í”Œë¡¯ ì˜ì—­ -->
        <div class="plot-frame">
            <div id="plot-area" style="width: 100%; height: 100%;">
                <div style="text-align: center; padding: 50px; color: #666;">
                    <p>ê³„ì‚° ë° ì‹œê°í™” ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Plotly.js -->
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    
    <!-- ì—í¬ë§Œ ìˆ˜ì†¡ ê³„ì‚° ë° ì‹œê°í™” JavaScript -->
    <script>
        // ì „ì—­ ë³€ìˆ˜
        let currentResults = null;
        
        // ìœ„ì¹˜ ë°ì´í„°
        const LOCATIONS = {
            'los_angeles': {lat: 34.0, wind: 3.0, wind_dir: 270},
            'busan': {lat: 35.1, wind: 3.5, wind_dir: 135},
            'north_pacific': {lat: 45.0, wind: 6.0, wind_dir: 135},
            'north_atlantic': {lat: 50.0, wind: 8.0, wind_dir: 270},
            'southern_ocean': {lat: -60.0, wind: 11.0, wind_dir: 270},
            'equator': {lat: 2.0, wind: 2.0, wind_dir: 90}
        };
        
        // ë¬¼ë¦¬ ìƒìˆ˜
        const RHO_WATER = 1025;  // kg/mÂ³
        const RHO_AIR = 1.225;   // kg/mÂ³
        const CD = 0.0013;       // í•­ë ¥ ê³„ìˆ˜
        const OMEGA = 7.2921e-5; // ì§€êµ¬ ìì „ ê°ì†ë„ (rad/s)
        
        // ìŠ¬ë¼ì´ë” ê°’ ì—…ë°ì´íŠ¸
        function updateSliderValues() {
            document.getElementById('wind_speed_value').textContent = parseFloat(document.getElementById('wind_speed').value).toFixed(1);
            document.getElementById('wind_direction_value').textContent = parseFloat(document.getElementById('wind_direction').value).toFixed(0);
            document.getElementById('latitude_value').textContent = parseFloat(document.getElementById('latitude').value).toFixed(0);
            document.getElementById('depth_value').textContent = parseFloat(document.getElementById('depth').value).toFixed(0);
        }
        
        // ì‚¬ì „ ì„¤ì •
        function setPreset(type) {
            if (type === 'normal') {
                document.getElementById('wind_speed').value = 10.0;
                document.getElementById('wind_direction').value = 0;
                document.getElementById('latitude').value = 30;
                document.getElementById('depth').value = 100;
            } else if (type === 'strong') {
                document.getElementById('wind_speed').value = 20.0;
                document.getElementById('wind_direction').value = 45;
                document.getElementById('latitude').value = 45;
                document.getElementById('depth').value = 150;
            } else if (type === 'typhoon') {
                document.getElementById('wind_speed').value = 30.0;
                document.getElementById('wind_direction').value = 90;
                document.getElementById('latitude').value = 25;
                document.getElementById('depth').value = 200;
            }
            updateSliderValues();
        }
        
        // ì§€ì—­ ì„ íƒ
        function onLocationSelect() {
            const selected = document.getElementById('location').value;
            if (selected !== 'custom' && LOCATIONS[selected]) {
                const loc = LOCATIONS[selected];
                document.getElementById('latitude').value = loc.lat;
                document.getElementById('wind_speed').value = loc.wind;
                document.getElementById('wind_direction').value = loc.wind_dir;
                updateSliderValues();
            }
        }
        
        // ì½”ë¦¬ì˜¬ë¦¬ ë§¤ê°œë³€ìˆ˜ ê³„ì‚°
        function calculateCoriolisParameter(latitude) {
            return 2 * OMEGA * Math.sin(latitude * Math.PI / 180);
        }
        
        // ì—í¬ë§Œ ìˆ˜ì†¡ ê³„ì‚°
        function calculateEkmanTransport(windSpeed, windDirection, latitude, depth) {
            if (latitude === 0) latitude = 1e-6; // 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€
            
            const f = calculateCoriolisParameter(latitude);
            const windStress = RHO_AIR * CD * windSpeed * windSpeed;
            const windDirRad = windDirection * Math.PI / 180;
            
            const tauX = windStress * Math.cos(windDirRad);
            const tauY = windStress * Math.sin(windDirRad);
            
            const Mx = -tauY / (RHO_WATER * f);
            const My = tauX / (RHO_WATER * f);
            
            const K = 0.01; // ìˆ˜ì§ ë‚œë¥˜ ì ì„± ê³„ìˆ˜
            const ekmanDepth = Math.PI * Math.sqrt(2 * K / Math.abs(f));
            
            // ì—í¬ë§Œ ë‚˜ì„  ê³„ì‚°
            const zLevels = [];
            const uVel = [];
            const vVel = [];
            
            for (let i = 0; i < 50; i++) {
                const z = (depth / 49) * i;
                zLevels.push(z);
                
                const a = Math.sqrt(Math.abs(f) / (2 * K));
                const factor = Math.exp(-a * z) / (RHO_WATER * Math.sqrt(2 * K * Math.abs(f)));
                const cosAz = Math.cos(a * z);
                const sinAz = Math.sin(a * z);
                const sgnF = Math.sign(f);
                
                const u = factor * (tauX * cosAz - sgnF * tauY * sinAz);
                const v = factor * (sgnF * tauX * sinAz + tauY * cosAz);
                
                uVel.push(u);
                vVel.push(v);
            }
            
            const energyTransfer = tauX * uVel[0] + tauY * vVel[0];
            
            return {
                windSpeed, windDirection, latitude, depth,
                windStress, tauX, tauY, Mx, My, ekmanDepth,
                zLevels, uVel, vVel, f, energyTransfer
            };
        }
        
        // í…Œë§ˆ ê°ì§€ í•¨ìˆ˜
        function isDarkMode() {
            return window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        }
        
        // í…Œë§ˆì— ë”°ë¥¸ ìƒ‰ìƒ ë°˜í™˜
        function getThemeColors() {
            const dark = isDarkMode();
            return {
                background: dark ? '#2b2b2b' : 'white',
                paper: dark ? '#1e1e1e' : 'white',
                text: dark ? '#ffffff' : '#000000',
                grid: dark ? '#404040' : 'lightgray',
                font: dark ? '#e0e0e0' : '#333333'
            };
        }
        
        // 2D ì‹œê°í™” ìƒì„±
        function create2DPlot(results) {
            const traces = [];
            const colors = getThemeColors();
            
            // 1. ë°”ëŒ vs ìˆ˜ì†¡ ë²¡í„°
            const windDirRad = results.windDirection * Math.PI / 180;
            const windX = results.windSpeed * Math.cos(windDirRad);
            const windY = results.windSpeed * Math.sin(windDirRad);
            
            traces.push({
                x: [0, windX], y: [0, windY],
                mode: 'lines+markers',
                line: {color: '#FF6B35', width: 4},
                marker: {size: 10},
                name: `ë°”ëŒ ${results.windSpeed.toFixed(1)} m/s`,
                xaxis: 'x', yaxis: 'y'
            });
            
            const transportScale = 1e6;
            traces.push({
                x: [0, results.Mx * transportScale], 
                y: [0, results.My * transportScale],
                mode: 'lines+markers',
                line: {color: '#4A9EFF', width: 4},
                marker: {size: 10},
                name: `ìˆ˜ì†¡ ${Math.sqrt(results.Mx**2 + results.My**2).toExponential(2)} mÂ³/s`,
                xaxis: 'x', yaxis: 'y'
            });
            
            // 2. ì—í¬ë§Œ ë‚˜ì„ 
            traces.push({
                x: results.uVel, y: results.vVel,
                mode: 'lines+markers',
                line: {color: '#FF4081', width: 3},
                marker: {
                    size: 6,
                    color: results.zLevels,
                    colorscale: 'Viridis',
                    showscale: true,
                    colorbar: {
                        title: {text: "ê¹Šì´ (m)", font: {color: colors.text}}, 
                        x: 0.48, y: 0.75, len: 0.25,
                        bgcolor: colors.background,
                        bordercolor: colors.grid,
                        tickfont: {color: colors.text}
                    }
                },
                name: 'ì—í¬ë§Œ ë‚˜ì„ ',
                xaxis: 'x2', yaxis: 'y2'
            });
            
            // 3. ê¹Šì´ë³„ ì†ë„ í”„ë¡œíŒŒì¼
            traces.push({
                x: results.uVel, y: results.zLevels.map(z => -z),
                mode: 'lines+markers',
                line: {color: '#1F77B4', width: 3},
                marker: {size: 4},
                name: 'U ì†ë„ (ë™-ì„œ)',
                xaxis: 'x3', yaxis: 'y3'
            });
            
            traces.push({
                x: results.vVel, y: results.zLevels.map(z => -z),
                mode: 'lines+markers',
                line: {color: '#FF7F0E', width: 3},
                marker: {size: 4},
                name: 'V ì†ë„ (ë‚¨-ë¶)',
                xaxis: 'x3', yaxis: 'y3'
            });
            
            // 4. ìˆ˜ì†¡ ì„±ë¶„ ë°” ì°¨íŠ¸
            traces.push({
                x: ['Mx (ë™-ì„œ)', 'My (ë‚¨-ë¶)'],
                y: [results.Mx, results.My],
                type: 'bar',
                marker: {color: ['#1F77B4', '#FF7F0E']},
                name: 'ìˆ˜ì†¡ ì„±ë¶„',
                xaxis: 'x4', yaxis: 'y4'
            });
            
            const layout = {
                title: {
                    text: `ğŸŒŠ ì—í¬ë§Œ ìˆ˜ì†¡ ë¶„ì„ (ìœ„ë„: ${results.latitude.toFixed(1)}Â°)`,
                    font: {color: colors.text, size: 16}
                },
                grid: {rows: 2, columns: 2, pattern: 'independent'},
                
                // ëª¨ë“  ì¶• ìŠ¤íƒ€ì¼ë§
                xaxis: {
                    title: {text: 'ë™-ì„œ ë°©í–¥ (m/s)', font: {color: colors.text}}, 
                    domain: [0, 0.45],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                yaxis: {
                    title: {text: 'ë‚¨-ë¶ ë°©í–¥ (m/s)', font: {color: colors.text}}, 
                    domain: [0.55, 1],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                xaxis2: {
                    title: {text: 'U ì†ë„ (m/s)', font: {color: colors.text}}, 
                    domain: [0.55, 1],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                yaxis2: {
                    title: {text: 'V ì†ë„ (m/s)', font: {color: colors.text}}, 
                    domain: [0.55, 1],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                xaxis3: {
                    title: {text: 'ì†ë„ (m/s)', font: {color: colors.text}}, 
                    domain: [0, 0.45],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                yaxis3: {
                    title: {text: 'ê¹Šì´ (m)', font: {color: colors.text}}, 
                    domain: [0, 0.45],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                xaxis4: {
                    title: {text: 'ì„±ë¶„', font: {color: colors.text}}, 
                    domain: [0.55, 1],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                yaxis4: {
                    title: {text: 'ìˆ˜ì†¡ëŸ‰ (mÂ³/s)', font: {color: colors.text}}, 
                    domain: [0, 0.45],
                    gridcolor: colors.grid,
                    tickfont: {color: colors.text},
                    linecolor: colors.grid
                },
                
                height: 800,
                showlegend: true,
                font: {size: 12, color: colors.text},
                plot_bgcolor: colors.background,
                paper_bgcolor: colors.paper,
                legend: {
                    font: {color: colors.text},
                    bgcolor: 'rgba(0,0,0,0)'
                }
            };
            
            return {data: traces, layout: layout};
        }
        
        // 3D ì‹œê°í™” ìƒì„±
        function create3DPlot(results) {
            const traces = [];
            const colors = getThemeColors();
            const speeds = results.uVel.map((u, i) => Math.sqrt(u*u + results.vVel[i]*results.vVel[i]));
            
            // ì—í¬ë§Œ ë‚˜ì„  3D
            traces.push({
                x: results.uVel,
                y: results.vVel,
                z: results.zLevels.map(z => -z),
                mode: 'lines+markers',
                type: 'scatter3d',
                line: {
                    color: speeds,
                    colorscale: 'Viridis',
                    width: 8,
                    colorbar: {
                        title: {
                            text: "ì†ë„ í¬ê¸° (m/s)", 
                            font: {color: colors.text, size: 16},
                            side: 'right'
                        },
                        bgcolor: colors.background,
                        bordercolor: colors.grid,
                        borderwidth: 2,
                        tickfont: {color: colors.text, size: 14},
                        len: 0.8,
                        thickness: 25,
                        x: 1.02,
                        xanchor: 'left',
                        y: 0.5,
                        yanchor: 'middle'
                    }
                },
                marker: {size: 4, color: speeds, colorscale: 'Viridis'},
                name: 'ì—í¬ë§Œ ë‚˜ì„ '
            });
            
            // ë°”ëŒ ë²¡í„°
            const windDirRad = results.windDirection * Math.PI / 180;
            const windX = results.windSpeed * Math.cos(windDirRad) * 0.01;
            const windY = results.windSpeed * Math.sin(windDirRad) * 0.01;
            
            traces.push({
                x: [0, windX], y: [0, windY], z: [10, 10],
                mode: 'lines+markers',
                type: 'scatter3d',
                line: {color: '#FF6B35', width: 10},
                marker: {size: 8, color: '#FF6B35'},
                name: `ğŸŒ¬ï¸ ë°”ëŒ ${results.windSpeed.toFixed(1)} m/s`
            });
            
            // ì—í¬ë§Œ ê¹Šì´ë³„ ë²¡í„° í•„ë“œ í‘œì‹œ
            const step = Math.max(1, Math.floor(results.zLevels.length / 8));
            for (let i = 0; i < results.zLevels.length; i += step) {
                const scale = 0.02;
                const alpha = 0.6;
                traces.push({
                    x: [0, results.uVel[i] * scale],
                    y: [0, results.vVel[i] * scale],
                    z: [-results.zLevels[i], -results.zLevels[i]],
                    mode: 'lines',
                    type: 'scatter3d',
                    line: {
                        color: `rgba(${isDarkMode() ? '100, 149, 237' : '30, 144, 255'}, ${alpha})`,
                        width: 4
                    },
                    showlegend: false,
                    hovertemplate: `ê¹Šì´: ${results.zLevels[i].toFixed(1)}m<br>ì†ë„: ${speeds[i].toFixed(4)} m/s<extra></extra>`
                });
            }
            
            const layout = {
                title: {
                    text: `ğŸŒŠ 3D ì—í¬ë§Œ ìˆ˜ì†¡ ì‹œê°í™” (ìœ„ë„: ${results.latitude.toFixed(1)}Â°)`,
                    font: {color: colors.text, size: 18},
                    x: 0.5,
                    y: 0.95
                },
                scene: {
                    bgcolor: colors.background,
                    xaxis: {
                        title: {text: 'U ì†ë„ (ë™-ì„œ, m/s)', font: {color: colors.text, size: 14}},
                        gridcolor: colors.grid,
                        tickfont: {color: colors.text, size: 12},
                        linecolor: colors.grid,
                        backgroundcolor: colors.background
                    },
                    yaxis: {
                        title: {text: 'V ì†ë„ (ë‚¨-ë¶, m/s)', font: {color: colors.text, size: 14}},
                        gridcolor: colors.grid,
                        tickfont: {color: colors.text, size: 12},
                        linecolor: colors.grid,
                        backgroundcolor: colors.background
                    },
                    zaxis: {
                        title: {text: 'ê¹Šì´ (m)', font: {color: colors.text, size: 14}},
                        gridcolor: colors.grid,
                        tickfont: {color: colors.text, size: 12},
                        linecolor: colors.grid,
                        backgroundcolor: colors.background
                    },
                    camera: {
                        eye: {x: 1.8, y: 1.8, z: 1.5}
                    },
                    aspectmode: 'cube'
                },
                autosize: true,
                width: null,
                height: null,
                margin: {l: 0, r: 0, t: 60, b: 0},
                font: {size: 14, color: colors.text},
                plot_bgcolor: colors.background,
                paper_bgcolor: colors.paper,
                legend: {
                    font: {color: colors.text, size: 12},
                    bgcolor: 'rgba(0,0,0,0)',
                    x: 0.02,
                    y: 0.98
                }
            };
            
            return {data: traces, layout: layout};
        }
        
        // ë©”ì¸ ê³„ì‚° ë° ì‹œê°í™” í•¨ìˆ˜
        function calculateAndVisualize() {
            try {
                console.log("ğŸ”„ ê³„ì‚° ì‹œì‘...");
                
                const windSpeed = parseFloat(document.getElementById('wind_speed').value);
                const windDirection = parseFloat(document.getElementById('wind_direction').value);
                let latitude = parseFloat(document.getElementById('latitude').value);
                const depth = parseFloat(document.getElementById('depth').value);
                
                if (latitude === 0) {
                    latitude = 1;
                    document.getElementById('latitude').value = 1;
                    updateSliderValues();
                }
                
                const results = calculateEkmanTransport(windSpeed, windDirection, latitude, depth);
                currentResults = results;
                
                const visType = document.querySelector('input[name="vis_type"]:checked').value;
                
                let plotData;
                if (visType === '3d') {
                    plotData = create3DPlot(results);
                } else {
                    plotData = create2DPlot(results);
                }
                
                const config = {
                    displayModeBar: true,
                    displaylogo: false,
                    responsive: true,
                    modeBarButtonsToAdd: ['downloadpng'],
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'ekman_transport_plot',
                        height: 1000,
                        width: 1600,
                        scale: 2
                    }
                };
                
                document.getElementById('plot-area').innerHTML = '';
                Plotly.newPlot('plot-area', plotData.data, plotData.layout, config);
                
                // í™”ë©´ í¬ê¸° ë³€ê²½ ì‹œ ìë™ ë¦¬ì‚¬ì´ì¦ˆ
                window.addEventListener('resize', function() {
                    Plotly.Plots.resize('plot-area');
                });
                
                updateResultsDisplay(results);
                
                console.log("âœ… ê³„ì‚° ë° ì‹œê°í™” ì™„ë£Œ!");
                
            } catch (error) {
                console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", error);
                document.getElementById('plot-area').innerHTML = 
                    `<div style="color: red; text-align: center; padding: 50px; font-size: 16px;">
                        ì˜¤ë¥˜: ${error.message}<br>íŒŒë¼ë¯¸í„°ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.
                    </div>`;
            }
        }
        
        // ê²°ê³¼ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateResultsDisplay(results) {
            document.getElementById('wind_stress').textContent = 
                `${(results.windStress * 1000).toFixed(3)} mN/mÂ²`;
            document.getElementById('ekman_depth').textContent = 
                `${results.ekmanDepth.toFixed(2)} m`;
            
            const totalTransport = Math.sqrt(results.Mx**2 + results.My**2);
            document.getElementById('total_transport').textContent = 
                `${totalTransport.toExponential(3)} mÂ³/s`;
            document.getElementById('energy_transfer').textContent = 
                `${(results.energyTransfer * 1000).toFixed(4)} mW/mÂ²`;
        }
        
        // ë‚´ë³´ë‚´ê¸°
        function exportResults() {
            if (!currentResults) {
                console.log("âŒ ë¨¼ì € ê³„ì‚°ì„ ìˆ˜í–‰í•˜ì„¸ìš”.");
                return;
            }
            
            const exportData = {
                'ì…ë ¥ íŒŒë¼ë¯¸í„°': {
                    'ë°”ëŒì†ë„ (m/s)': currentResults.windSpeed,
                    'ë°”ëŒë°©í–¥ (Â°)': currentResults.windDirection,
                    'ìœ„ë„ (Â°)': currentResults.latitude,
                    'ê¹Šì´ (m)': currentResults.depth
                },
                'ê³„ì‚° ê²°ê³¼': {
                    'ë°”ëŒì‘ë ¥ (N/mÂ²)': currentResults.windStress.toExponential(6),
                    'ì—í¬ë§Œê¹Šì´ (m)': currentResults.ekmanDepth.toFixed(2),
                    'Mx ìˆ˜ì†¡ (mÂ³/s)': currentResults.Mx.toExponential(6),
                    'My ìˆ˜ì†¡ (mÂ³/s)': currentResults.My.toExponential(6),
                    'ì´ ìˆ˜ì†¡ëŸ‰ (mÂ³/s)': Math.sqrt(currentResults.Mx**2 + currentResults.My**2).toExponential(6),
                    'ì—ë„ˆì§€ì „ë‹¬ë¥  (W/mÂ²)': currentResults.energyTransfer.toExponential(6),
                    'ì½”ë¦¬ì˜¬ë¦¬ ë§¤ê°œë³€ìˆ˜': currentResults.f.toExponential(6)
                }
            };
            
            console.log("ğŸ“Š ë‚´ë³´ë‚´ê¸° ë°ì´í„°:");
            console.log(JSON.stringify(exportData, null, 2));
        }
        
        // í…Œë§ˆ ë³€ê²½ ê°ì§€ ë° ì°¨íŠ¸ ì—…ë°ì´íŠ¸
        function handleThemeChange() {
            if (currentResults) {
                // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ ì—…ë°ì´íŠ¸
                const visType = document.querySelector('input[name="vis_type"]:checked').value;
                let plotData;
                
                if (visType === '3d') {
                    plotData = create3DPlot(currentResults);
                } else {
                    plotData = create2DPlot(currentResults);
                }
                
                const config = {
                    displayModeBar: true,
                    displaylogo: false,
                    modeBarButtonsToAdd: ['downloadpng'],
                    toImageButtonOptions: {
                        format: 'png',
                        filename: 'ekman_transport_plot',
                        height: 800,
                        width: 1200,
                        scale: 2
                    }
                };
                
                                 Plotly.newPlot('plot-area', plotData.data, plotData.layout, config);
                 
                 // ì°¨íŠ¸ ë¦¬ì‚¬ì´ì¦ˆ ì ìš©
                 setTimeout(() => {
                     Plotly.Plots.resize('plot-area');
                 }, 100);
                 
                 console.log("ğŸ¨ í…Œë§ˆ ë³€ê²½ì— ë”°ë¼ ì°¨íŠ¸ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤!");
            }
        }
        
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        document.addEventListener('DOMContentLoaded', function() {
            // ìŠ¬ë¼ì´ë” ì´ë²¤íŠ¸
            ['wind_speed', 'wind_direction', 'latitude', 'depth'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateSliderValues);
            });
            
            // ì§€ì—­ ì„ íƒ ì´ë²¤íŠ¸
            document.getElementById('location').addEventListener('change', onLocationSelect);
            
            // ì‹œìŠ¤í…œ í…Œë§ˆ ë³€ê²½ ê°ì§€
            if (window.matchMedia) {
                const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
                mediaQuery.addEventListener('change', handleThemeChange);
                
                // ì´ˆê¸° í…Œë§ˆ ìƒíƒœ ë¡œê·¸
                console.log(`ğŸ¨ í˜„ì¬ í…Œë§ˆ: ${isDarkMode() ? 'ë‹¤í¬ ëª¨ë“œ' : 'ë¼ì´íŠ¸ ëª¨ë“œ'}`);
            }
            
            // ì‹œê°í™” íƒ€ì… ë³€ê²½ ì´ë²¤íŠ¸
            document.querySelectorAll('input[name="vis_type"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    if (currentResults) {
                        handleThemeChange(); // í…Œë§ˆì— ë§ê²Œ ë‹¤ì‹œ ë Œë”ë§
                    }
                });
            });
            
            // ì´ˆê¸°ê°’ ì„¤ì •
            updateSliderValues();
            
            console.log("ğŸŒŠ Ekman Transport Visualizer ë¡œë“œ ì™„ë£Œ!");
            console.log("ğŸ“Š íŒŒì´ì¬ ìŠ¤íƒ€ì¼ ì‹œê°í™”ê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.");
            console.log("ğŸŒ— ìë™ ë‹¤í¬/ë¼ì´íŠ¸ ëª¨ë“œ ì „í™˜ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.");
        });
    </script>
</body>
</html> 